% original Audapter upsampling filter (16KHz to 48KHz)
a0=[1.000000000000000000000000, -4.137689759094149300000000, 11.417342955970334000000000, -21.230389508442666000000000, 31.507204607241498000000000, -36.677292780605917000000000, 36.042584528469732000000000, -28.996821243768743000000000, 20.262367357856544000000000, -11.637468104552259000000000, 5.968975493498319000000000, -2.417954280896708500000000, 0.941027354810217260000000, -0.241109659478893040000000, 0.083935453370180629000000, -0.005511361553189712100000, 0.006142808678570149300000, 0.001292100725808184000000, 0.000588047191250507470000, 0.000146757274221299580000, 0.000035865709068928935000];
b0=[0.005985366448016847400000, -0.000000000068663473436596, 0.029926833561855812000000, 0.014963399494903253000000, 0.072946803942075492000000, 0.066399110082245749000000, 0.128831523706446540000000, 0.141307195958322970000000, 0.183515087779119460000000, 0.196038702055692930000000, 0.207578586483177310000000, 0.196038702055692630000000, 0.183515087779119760000000, 0.141307195958322280000000, 0.128831523706446790000000, 0.066399110082245277000000, 0.072946803942075533000000, 0.014963399494903067000000, 0.029926833561855826000000, -0.000000000068663525932820, 0.005985366448016846500000];
fs1=44100;                          % sampling frequency of filter in .bin files
fs2=48000;                          % sampling frequency of Audapter filter (higher or equal to fs1)

% load headset .bin files
filepathMAT='/Users/alfnie/Downloads/S14-504/EQfiltering_Matlab_Utility' % location of LOAD_BIN function
names={'/Users/alfnie/Downloads/S14-504/504L_504R/EQF_504L.bin','/Users/alfnie/Downloads/S14-504/504L_504R/EQF_504R.bin'}; % location of .bin files
%names={'/Users/alfnie/Downloads/S14-504/039L_039R/EQF_039L.bin','/Users/alfnie/Downloads/S14-504/039L_039R/EQF_039R.bin'}; % location of .bin files
pwd0=pwd;
cd(filepathMAT); % location of load_bin function
[h1,w1] = freqz(load_filter(names{1}),1,fs1/2); % Frequency response of L EQ filter
[h2,w2] = freqz(load_filter(names{2}),1,fs1/2); % Frequency response of R EQ filter
H=nan(2,fs2/2);
H(:,1:fs1/2)=abs([h1';h2']);
cd(pwd0)

% compute new IIR EQ filter coefficients
Ns=numel(a0)-1;
f=(0:fs2/2-1)/(fs2/2);
m=mean(H,1);                        % average Left and Right EQ filter responses
m(isnan(m))=0;
[m0,w0] = freqz(b0,a0,fs2/2);       % response of low-pass upsampling filter
m=m.*reshape(abs(m0),size(m));      % EQ filter * low-pass
%m(8001:end)=0;
[b,a] = yulewalk(Ns,[f 1],[m 0]);   % fit to a*y = b*x IIR standard filter coefficients
%[b,a]=invfreqz(m,f,Ns,Ns);
[m,w] = freqz(b,a,48000);scale=sqrt(mean(abs(m(w/pi*48000/2<=8000)).^2)); b=scale*b;
F={a,b};

% plot stuff
clf;
[mfit,wfit] = freqz(b,a,fs2/2); % Frequency response of filter
plot(0:fs2/2-1,20*log10(H),'-'); hold on; plot(fs2/2*wfit/pi,20*log10(abs(mfit)),'k-',w0/pi*fs2/2,20*log10(abs(m0)),'b-','linewidth',2); hold off;
xlabel('Frequency (Hz)');
set(gca,'xlim',[100 fs2/2],'xscale','log'); grid on;
fprintf('a = %s\nb = %s\n',mat2str(a),mat2str(b));
[nill,tname,nill]=fileparts(names{1}); title([regexprep(tname,{'^EQF_','L$'},''),' EQfilter']);
legend('Left EQ filter (513 samples)','Right EQ filter (513 samples)','fitted EQ + 16KHz upsampling filter (21 samples)','original 16KHz upsampling filter (21 samples)');
set(gca,'ylim',[-70 2],'xlim',[100 2*8000],'xtick',[100 200 400 1e3 3e3 7e3 16e3]);
%conn_print EQ_filter_039.jpg -nogui

%a = [1 -5.75471474086736 15.9791443224195 -27.8453958746592 33.8679184114231 -31.3865228777312 25.3492709502468 -20.9153500856605 17.9606358134845 -14.8555875997507 12.3637115362324 -11.1903050536838 9.94268179949726 -7.71432259505361 5.60413356746172 -4.47470820603634 3.63628524621226 -2.38742427225541 1.08430775892996 -0.299453305156428 0.0383804002233832]
%b = [0.00570966595476346 -0.0112376169798971 0.0145754220683358 -0.0113190264529328 0.00644652023695776 -0.00365396238219983 0.00136510405311595 -0.00117107203692529 0.000170416836377158 2.10131851304439e-05 0.000131176108787179 -0.000742544816345201 0.00207734085707366 -0.0023577953561914 0.00677480722095782 -0.0118854702086538 0.0145060836128372 -0.0111439409018681 0.00491146766886396 -0.000997814774383153 -0.000235130515760644]

